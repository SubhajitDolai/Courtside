name: Deactivate Sports Cron Job

on:
  schedule:
    - cron: '30 17 * * 6' # Runs Saturday at 5:30 PM UTC (Saturday 11:00 PM IST) â€” Deactivates sports for Sunday
  workflow_dispatch: # Enables manual trigger

jobs:
  deactivate-sports:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Stops the job after 10 minutes if it doesn't complete
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Call Deactivate Sports API with Retry Logic
        env:
          SECRET_KEY: ${{ secrets.BACKUP_CRON_SECRET }}
          API_URL: ${{ secrets.DEACTIVATE_SPORTS_API_URL }}
        run: |
          for i in {1..3}; do
            response=$(curl -X POST -s -w "%{http_code}" -o response_body.txt "$API_URL?secret=$SECRET_KEY")
            echo "Attempt $i: API Response Code: $response"
            echo "API Response Body:"
            cat response_body.txt
            if [ "$response" -eq 200 ]; then
              echo "Sports deactivation succeeded! Sunday is now OFF."
              break
            else
              echo "Sports deactivation failed. Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ "$response" -ne 200 ]; then
            echo "Sports deactivation failed after 3 attempts. Exiting with error."
            exit 1
          fi
